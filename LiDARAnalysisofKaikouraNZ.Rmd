---
title: "LiDAR Analysis of Kaikoura NZ"
date: '2018-12-07'
slug: lidar-kaikoura
tags:
- R
- GIS
- EDA
categories: Post
---


+ [Introduction](#introduction)
+ [Data Overview](#data overview)
+ [Load Data](#load-data)
+ [Data Manipulation](#data-manipulation)
+ [Data Exploration](#data-exploration)
+ [Data Visualisation](#data-visualisation)
+ [Conclusions](#conclusions)

## Introduction

The [Kaikoura earthquake](https://www.geonet.org.nz/earthquake/2016p858000) happened just after midnight on 14 November 2016.

After reading this article [Astonishing Nasa photos show Kaikoura land raised by earthquake](https://www.stuff.co.nz/national/87171157/Astonishing-Nasa-photos-show-Kaikoura-land-raised-by-earthquake) I thought it would interesting to look at what open data is available to view the land changes from the article.


This analysis has the following objectives:

- Import, manipulate and visualise both vector and raster spatial data 
- Use different spatial extents
- Use LiDAR remote sensing open data
- Explore and use different Coordinate Reference System formats including proj.4, EPSG and WKT
- Reproject vector and raster data to different CRS  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r load packages, message=FALSE, warning=FALSE}
# Tidyverse metapackage
library(tidyverse)
# Package for reading spatial datasets
library(rgdal)
library(raster)
# Package for manipulating and plotting spatial data
library(sf)
# Package for downloading OSM data
library(osmdata)
# Package for plotting OSM basemap
library(osmplotr)
# Package for interactive maps
library(leaflet)
# Package for raster vis
library(rasterVis)
```


## Data Overview 

### LiDAR Data

LiDAR or Light Detection and Ranging is an active remote sensing system that can be used to measure vegetation height across wide areas.

[LiDAR DEM data from before the earthquakes](https://data.linz.govt.nz/layer/3542-canterbury-kaikoura-lidar-1m-dem-2012/) is available for Kaikoura, Canterbury, New Zealand 2012:  	  
 	
> Lidar was captured for Environment Canterbury Regional Council by Aerial Surveys in 2012. Note that this capture was prior to the significant vertical and horizontal displacements from the 2016 Kaikoura earthquakes. The datasets were generated by Aerial Surveys and their subcontractors. The survey area includes the Kaikoura township area and adjacent coastal strips. Data management and distribution is by Land Information New Zealand. 


## Load Data

### Create a Kaikoura Bounding Box

Let's create a bounding box or bbox which can be described as the spatial extent of the area of Kaikoura we want to initially analyse.

Create a bbox using the getbb function from [osmdata](https://cran.r-project.org/web/packages/osmdata/index.html) R package of Kaikoura town.

```{r kaikoura bbox}
# Get longitude and latitude coordinates for a Kaikoura bbox using osmdata package
kaikoura_bbox<- getbb("Kaikoura")
# Take a look at the CRS
crs(kaikoura_bbox)
# Plot the bbox 
plot(kaikoura_bbox)
```

Currently this bbox object has no CRS and it consists of two points? Ideally we would like a polygon shape.  Let's get the bbox as an [sf](https://cran.r-project.org/web/packages/sf/index.html) object after following the package [examples](https://rdrr.io/cran/osmdata/man/getbb.html).


```{r kaikoura bbox take 2}
# Get Kaikoura bbox polygon seeting the format to sf
kaikoura_bbox_sf<- osmdata::getbb("Kaikoura", format_out = "sf_polygon")
# View the kaikoura_bbox_sf
kaikoura_bbox_sf
# We can check the bbox extent of our sf object using st_bbox function
st_bbox(kaikoura_bbox_sf)
# Check the crs of the bbox
st_crs(kaikoura_bbox_sf)
# Now plot the bbox sf object using ggplot and geom_sf to check that it is a box/pologon
ggplot(kaikoura_bbox_sf)+
      geom_sf()
```

The Coordinate Reference System (CRS) is the [WGS84 (EPSG 4326) system](http://openstreetmapdata.com/info/projections):

> OpenStreetMap uses the WGS84 spatial reference system used by the Global Positioning System (GPS). It uses geographic coordinates between -180째 and 180째 longitude and -90째 and 90째 latitude. So this is the "native" OSM format.

Let's plot this bbox using [leaflet](https://cran.r-project.org/web/packages/leaflet/index.html) R package to see where it is on a map.

```{r leaflet map kaikoura}
# Map Kaikoura using leaflet and the bbox
kaikoura_bbox_sf %>% 
      leaflet() %>% 
      addTiles() %>%
      addPolylines()
```

Longitude and latitude is useful for navigation and locating places on a map but not for data analysis or measurement so we need use a consistent map projection for all our data.

Maps of New Zealand used for data analysis use [New Zealand Transverse Mercator / New Zealand Geodetic Datum 2000 (EPSG:2193)](https://lris.scinfo.org.nz/p/lris_faqs/EPSG:2193).

Now we want to project the bbox to [EPSG 2193](http://spatialreference.org/ref/epsg/nzgd2000-new-zealand-transverse-mercator-2000/) which is in metres instead of degrees. We will create a Well-known text (WKT) polygon to export to and load in QGIS to visualise the raster data sets within this bbox.

```{r create wkt polygon for QGIS}
# Change the Epsg of the bbox to EPSG 2193 for NZ using st_transform
kaikoura_bbox_sf_2193<- st_transform(kaikoura_bbox_sf,2193)
# Check the crs of the transformed bbox
st_crs(kaikoura_bbox_sf_2193)
# We can check the bbox extent  of our reprojected sf object in metres using st_bbox function
st_bbox(kaikoura_bbox_sf_2193)
# Create a WKT from the bbox class using sf package
Kaikoura_WKT <- st_as_text(st_geometry(kaikoura_bbox_sf_2193)) %>%  
      data.frame()
# Write the WKT to file to be imported into QGIS
# write_csv(Kaikoura_WKT,"kaikoura_wkt.csv")
```

### Import the LiDAR Data

Import the LiDAR data in raster or gridded format using the [raster](https://cran.r-project.org/web/packages/raster/index.html) R package. We will first inspect one sample tif file as there are a large number of files from the downloaded zip file.

The GeoTIFF format contains a set of embedded or tif tags with metadata about the raster data.  We can use the function GDALinfo() from [rgdal](https://cran.r-project.org/web/packages/rgdal/index.html) R package to get information ie metadata about our raster data before we read that data into R. It is ideal to do this before importing your data.

```{r inspect sample lidar data, warning=FALSE}
# Preview metadata using GDALinfo from rgdal package
GDALinfo("data/DEM_BT27_2012_1000_4343.tif")
# Import raster sample file with raster package
lidar_sample <- raster(x = "data/DEM_BT27_2012_1000_4343.tif")
# Take a look at the class of this object
class(lidar_sample)
# Check the CRS of the lidar sample file
crs(lidar_sample)
```

The file is a "RasterLayer", a single layer of raster data and the CRS is in proj.4 format with [the transverse Mercator projection](https://proj4.org/operations/projections/tmerc.html):

- proj=tmerc
- k=0.9996 Scale factor. Determines scale factor used in the projection.
- x_0=1600000 False easting
- y_0=10000000 False northing
- units=m: the units for the coordinates are in METERS
- ellps=GRS80: the ellipsoid (how the earth's roundness is calculated) for the data is GRS80

Each LiDAR point has an elevation value, which adds a third dimension to the spatial data.

```{r import lidar rasters}
# Create a list of the file paths of the tif files and select rasters DEM_BT27_2012_1000_434*.tif based on a more detailed area we look for to analyse based on QGIS analysis using glob2rx function https://stackoverflow.com/questions/14360174/list-files-pattern-argument-in-r-extended-regular-expression-use
list_tifs <- list.files(path = "data/", pattern = glob2rx("DEM_BT27_2012_1000_434*.tif"), full.names = TRUE)
# Create a list of raster layers from the list_tifs
raster_list <- map(list_tifs, raster)
# Take a look at the first raster in the list
raster_list[[1]]
```


## Data Manipulation

Now let's manipulate the data that we have imported. First merge the LiDAR rasters.

```{r merge rasters}
# Now use the raster merge function to merge the raster layers of the lidar data
kaikoura_lidar <- do.call(raster::merge, c(raster_list, tolerance = 1))
# Write the merged raster as object for QGIS
# writeRaster(kaikoura_lidar,"kaikoura_lidar.tiff")
```

Let's check the extents of the raster sets.

```{r raster extents}
# Check the extent of the lidar raster
extent(kaikoura_lidar)
```

Next we will create and visualise an Area of Interest (AOI) from the LiDAR rasters. These capture areas where the seabeds lifted after the Kaikoura earthquake.

```{r set AOI}
# Created AOI from the lidar raster extent
AOI <- as(extent(kaikoura_lidar),'SpatialPolygons') 
# Set the CRS to the lidar data proj4string
crs(AOI)@projargs <- crs(kaikoura_lidar)@projargs
# Create a sf object
AOI_sf <- st_as_sf(AOI)
# Set the CRS to EPSG 2193
AOI_sf <- st_transform(AOI_sf,2193)
```

```{r create AOI wkt polygon for QGIS}
# Check the crs of the transformed bbox
st_crs(AOI_sf)
# We can check the bbox extent  of our reprojected sf object is in metres using st_bbox function
st_bbox(AOI_sf)
# Create a WKT from the bbox class using sf package
AOI_WKT <- st_as_text(st_geometry(AOI_sf)) %>%  
      data.frame()
# Write the WKT to file to be imported into QGIS
# write_csv(AOI_WKT,"AOI_wkt.csv")
```

```{r leaflet map AOI}
# Set the EPSG to the native OSM EPSG 4326 https://rstudio.github.io/leaflet/projections.html for purposes of visualising the AOI rather than customing the leafletCRS to EPSG: 2193 
AOI_sf_4326 <- st_transform(AOI_sf,4326)
# Map AOI using leaflet
m<- AOI_sf_4326 %>% 
      leaflet() %>% 
      addTiles() %>%
      addPolylines()
m
# Save htmlwidget for blog post
# htmlwidgets::saveWidget(m,"AOI.html")
```

Now convert the merged LiDAR raster to a dataframe.

```{r lidar raster to df}
# Convert the raster data to a dataframe
kaikoura_lidar_df <- as.data.frame(kaikoura_lidar, xy = TRUE)
```


## Data Exploration

Now plot the distribution of elevation values within the area of interest using our LiDAR raster data.
 
```{r elevation histogram}
# plot histogram using ggplot
ggplot(kaikoura_lidar_df,aes(layer)) +
      geom_histogram()+
      ggtitle("Distribution of surface elevation values") +
      xlab("Elevation (meters)") + 
      ylab("Frequency") 
# Find the highest point in the AOI
highest_point <- kaikoura_lidar_df %>% 
      top_n(1)
highest_point
```

From this histogram it seems this coastal land has some flat sea level land and steep sections to hilly viewpoints. 

We could use LiDAR data from after the earthquake to measure the earth and seabed movements from the elevation differences if this data is made available by LINZ.

## Data Visualisation

Let's visualise the LiDAR raster in our AOI using base plot and levelplot from the [rasterVis](https://cran.r-project.org/web/packages/rasterVis/index.html) R package.

```{r plot lidar raster}
# Use base plot to plot the lidar raster with the highest point
plot(kaikoura_lidar,sub="Source: LINZ CC 4.0") + title("Digital Elevation Model (DEM) Data \n Kaikoura, New Zealand \n Before the Earthquake in 2012")
points(highest_point,col="green",pch = 19)
# Plot levelplotusing rasterVis package
levelplot<- levelplot(kaikoura_lidar, layers = 1, margin = list(FUN = 'median'), contour=TRUE)
levelplot
```

Now let's view a recent satellite imagery so see what the sea beds look like now.

```{r plot satellite image after the quakes}
# Map AOI using leaflet with satellite basemap
m2 <- AOI_sf_4326 %>% 
      leaflet() %>% 
      addTiles() %>%
      addProviderTiles(providers$Esri.WorldImagery) %>%
      addPolylines()
m2
# htmlwidgets::saveWidget(m2,"SatelliteAfterQuakes.html")
```

We can see the raised sea beds from the earthquake in the leaflet satellite plot. 

## Conclusions

This has been a great venture into using raster data and different coordinate systems. One of the main challenges with this type of data is that it is very big and so it is useful to know other tools such as QGIS.

Other lessons learnt include:

- Use base plot in R for initial visualisations of raster data as these data may be very large and using ggplot may just crash your PC.
- Select the appropriate CRS up front in the data analysis and then reproject data. However reprojections of raster datasets can also be memory intensive. Using QGIS for on the fly projections are a good way to take a look at the data.
- Most basic plots use the native OSM unprojected CRM system of WGS84. Since leaflet also defaults to this CRS, this would be the familiar starting point for first attempts at geospatial analysis.
- Another way to view DEM's is with 3D and there is so much more scope for playing with 3D R packages and other tools.